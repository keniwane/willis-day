var Y=Object.defineProperty;var _=(s,t,e)=>t in s?Y(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var C=(s,t,e)=>(_(s,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const d of n.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();class U{constructor(){this.toLoad={sky:"sprites/sky.png",ground:"sprites/ground.png",hero:"sprites/hero-sheet.png",shadow:"sprites/shadow.png",rod:"sprites/rod.png",house:"sprites/house.png",mail:"sprites/mail.png",icon:"sprites/icon.png",letter:"sprites/letter.png"},this.images={},Object.keys(this.toLoad).forEach(t=>{const e=new Image;e.src=this.toLoad[t],this.images[t]={image:e,isLoaded:!1},e.onload=()=>{this.images[t].isLoaded=!0}})}}const b=new U;class l{constructor(t=0,e=0){this.x=t,this.y=e}duplicate(){return new l(this.x,this.y)}}class X{constructor(){C(this,"callbacks",[]);C(this,"nextId",0)}emit(t,e){this.callbacks.forEach(i=>{i.eventName===t&&i.callback(e)})}on(t,e,i){return this.nextId+=1,this.callbacks.push({id:this.nextId,eventName:t,caller:e,callback:i}),this.nextId}off(t){this.callbacks=this.callbacks.filter(e=>e.id!==t)}unsubscribe(t){this.callbacks=this.callbacks.filter(e=>e.caller!==t)}}const A=new X;class I{constructor({position:t}){this.position=t??new l(0,0),this.children=[],this.parent=null,this.hasReadyBeenCalled=!1}stepEntry(t,e){this.children.forEach(i=>i.stepEntry(t,e)),this.hasReadyBeenCalled||(this.hasReadyBeenCalled=!0,this.ready()),this.step(t,e)}ready(){}step(t){}draw(t,e,i){const o=e+this.position.x,n=i+this.position.y;this.drawImage(t,o,n),this.children.forEach(d=>d.draw(t,o,n))}drawImage(t,e,i){}destroy(){this.children.forEach(t=>{t.destroy()}),this.parent.removeChild(this)}addChild(t){t.parent=this,this.children.push(t)}removeChild(t){A.unsubscribe(t),this.children=this.children.filter(e=>t!==e)}}class w extends I{constructor({resource:t,frameSize:e,hFrames:i,vFrames:o,frame:n,scale:d,position:c,animations:f}){super({name}),this.resource=t,this.frameSize=e??new l(16,16),this.hFrames=i??1,this.vFrames=o??1,this.frame=n??0,this.frameMap=new Map,this.scale=d??1,this.position=c??new l(0,0),this.animations=f??null,this.buildFrameMap()}buildFrameMap(){let t=0;for(let e=0;e<this.vFrames;e++)for(let i=0;i<this.hFrames;i++)this.frameMap.set(t,new l(this.frameSize.x*i,this.frameSize.y*e)),t++}step(t){this.animations&&(this.animations.step(t),this.frame=this.animations.frame)}drawImage(t,e,i){if(!this.resource.isLoaded)return;let o=0,n=0;const d=this.frameMap.get(this.frame);d&&(o=d.x,n=d.y);const c=this.frameSize.x,f=this.frameSize.y;t.drawImage(this.resource.image,o,n,c,f,e,i,c*this.scale,f*this.scale)}}class B{constructor(t,e){C(this,"mainLoop",t=>{if(!this.isRunning)return;let e=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulatedTime+=e;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=e,this.rafId=null,this.isRunning=!1}start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId&&cancelAnimationFrame(this.rafId),this.isRunning=!1}}const R="LEFT",D="RIGHT",W="UP",L="DOWN";class q{constructor(){this.heldDirections=[],document.addEventListener("keydown",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowPressed(W),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowPressed(L),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowPressed(R),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowPressed(D)}),document.addEventListener("keyup",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowReleased(W),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowReleased(L),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowReleased(R),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowReleased(D)})}get direction(){return this.heldDirections[0]}onArrowPressed(t){this.heldDirections.indexOf(t)===-1&&this.heldDirections.unshift(t)}onArrowReleased(t){const e=this.heldDirections.indexOf(t);e!==-1&&this.heldDirections.splice(e,1)}}const x=s=>s*16,G=(s,t,e)=>{const i=`${t},${e}`;return!s.has(i)},E=new Set;E.add("144,48");E.add("160,48");E.add("176,64");E.add("128,48");E.add("112,48");class ${constructor(t){this.patterns=t,this.activeKey=Object.keys(this.patterns)[0]}get frame(){return this.patterns[this.activeKey].frame}play(t,e=0){this.activeKey!==t&&(this.activeKey=t,this.patterns[this.activeKey].currentTime=e)}step(t){this.patterns[this.activeKey].step(t)}}class g{constructor(t){this.currentTime=0,this.animationConfig=t,this.duration=t.duration??500}get frame(){const{frames:t}=this.animationConfig;for(let e=t.length-1;e>=0;e--)if(this.currentTime>=t[e].time)return t[e].frame;throw"Time is before the first keyframe"}step(t){this.currentTime+=t,this.currentTime>=this.duration&&(this.currentTime=0)}}const z=(s=0)=>({duration:400,frames:[{time:0,frame:s}]}),F=(s=0)=>({duration:400,frames:[{time:0,frame:s+1},{time:100,frame:s},{time:200,frame:s+1},{time:300,frame:s+2}]}),j=z(1),Z=z(4),J=z(7),Q=z(10),V=F(0),tt=F(3),et=F(6),it=F(9),st={duration:400,frames:[{time:0,frame:12}]};function nt(s,t,e){let i=t.x-s.position.x,o=t.y-s.position.y,n=Math.sqrt(i**2+o**2);if(n<=e)s.position.x=t.x,s.position.y=t.y;else{let d=i/n,c=o/n;s.position.x+=d*e,s.position.y+=c*e,i=t.x-s.position.x,o=t.y-s.position.y,n=Math.sqrt(i**2+o**2)}return n}class ot extends I{constructor(e,i){super({position:new l(e,i)});C(this,"w");const o=new w({resource:b.images.shadow,frameSize:new l(32,32),position:new l(-8,-19)});this.addChild(o),this.body=new w({resource:b.images.hero,frameSize:new l(32,32),hFrames:3,vFrames:8,frame:1,position:new l(-8,-20),animations:new $({walkDown:new g(V),walkUp:new g(et),walkLeft:new g(it),walkRight:new g(tt),standDown:new g(j),standUp:new g(J),standLeft:new g(Q),standRight:new g(Z),pickUpDown:new g(st)})}),this.addChild(this.body),this.facingDirection=L,this.destinationPosition=this.position.duplicate(),this.itemPickupTime=0,this.itemPickupShell=null,A.on("HERO_PICKS_UP_ITEM",this,n=>{this.onPickUpItem(n)})}step(e,i){if(this.itemPickupTime>0){this.workOnItemPickup(e);return}nt(this,this.destinationPosition,1)<=1&&this.tryMove(i),this.tryEmitPosition()}tryEmitPosition(){this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,Math.floor(this.position.x/16),Math.floor(this.position.y/16),console.log(`Player grid position: (${this.lastX}, ${this.lastY})`),A.emit("HERO_POSITION",this.position))}tryMove(e){const{input:i}=e;if(!i.direction){this.facingDirection===R&&this.body.animations.play("standLeft"),this.facingDirection===D&&this.body.animations.play("standRight"),this.facingDirection===W&&this.body.animations.play("standUp"),this.facingDirection===L&&this.body.animations.play("standDown");return}let o=this.destinationPosition.x,n=this.destinationPosition.y;const d=16;i.direction===L&&(n+=d,this.body.animations.play("walkDown")),i.direction===W&&(n-=d,this.body.animations.play("walkUp")),i.direction===R&&(o-=d,this.body.animations.play("walkLeft")),i.direction===D&&(o+=d,this.body.animations.play("walkRight")),this.facingDirection=i.direction??this.facingDirection,G(E,o,n)&&(this.destinationPosition.x=o,this.destinationPosition.y=n)}onPickUpItem({image:e,position:i}){this.destinationPosition=i.duplicate(),this.itemPickupTime=500,this.itemPickupShell=new I({}),this.itemPickupShell.addChild(new w({resource:e,position:new l(0,-18)})),this.addChild(this.itemPickupShell)}workOnItemPickup(e){this.itemPickupTime-=e,this.body.animations.play("pickUpDown"),this.itemPickupTime<=0&&this.itemPickupShell.destroy()}}class at extends I{constructor(){super({}),A.on("HERO_POSITION",this,t=>{this.position=new l(-t.x+152,-t.y+82)})}}class rt extends I{constructor(){super({position:new l(0,1)}),this.nextId=0,this.items=[],A.on("HERO_PICKS_UP_ITEM",this,t=>{this.nextId+=1,this.items.push({id:this.nextId,image:b.images.rod}),this.renderInventory()}),this.renderInventory()}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,e)=>{const i=new w({resource:t.image,position:new l(e*12,0)});this.addChild(i)})}removeFromInventory(t){this.items=this.items.filter(e=>e.id!==t),this.renderInventory()}}const p=document.createElement("div");p.innerText="Will you be my valentine? ❤️ - Ken";p.style.position="absolute";p.style.fontFamily="'Press Start 2P', 'Courier New', monospace";p.style.fontSize="24px";p.style.color="#222";p.style.pointerEvents="none";p.style.display="none";document.body.appendChild(p);let N=!1;const r=document.createElement("button");r.innerText="Yes";r.style.position="absolute";r.style.fontFamily="'Press Start 2P', 'Courier New', monospace";r.style.fontSize="18px";r.style.padding="8px 24px";r.style.display="none";r.style.zIndex=10;r.style.background="#e0c080";r.style.border="4px solid #7c5c2c";r.style.borderRadius="0";r.style.boxShadow="0 0 0 2px #fff inset, 2px 2px 0 #7c5c2c";r.style.color="#3a2a0a";r.style.textShadow="1px 1px 0 #fff, -1px -1px 0 #fff";r.style.cursor="pointer";r.style.outline="none";r.style.transition="background 0.2s, box-shadow 0.2s";r.addEventListener("mouseenter",()=>{r.style.background="#fff6d6",r.style.boxShadow="0 0 0 2px #fff inset, 4px 4px 0 #7c5c2c"});r.addEventListener("mouseleave",()=>{r.style.background="#e0c080",r.style.boxShadow="0 0 0 2px #fff inset, 2px 2px 0 #7c5c2c"});document.body.appendChild(r);const a=document.createElement("button");a.innerText="No";a.style.position="absolute";a.style.fontFamily="'Press Start 2P', 'Courier New', monospace";a.style.fontSize="18px";a.style.padding="8px 24px";a.style.display="none";a.style.zIndex=10;a.style.background="#e0c080";a.style.border="4px solid #7c5c2c";a.style.borderRadius="0";a.style.boxShadow="0 0 0 2px #fff inset, 2px 2px 0 #7c5c2c";a.style.color="#3a2a0a";a.style.textShadow="1px 1px 0 #fff, -1px -1px 0 #fff";a.style.cursor="pointer";a.style.outline="none";a.style.transition="background 0.2s, box-shadow 0.2s";a.addEventListener("mouseenter",()=>{a.style.background="#fff6d6",a.style.boxShadow="0 0 0 2px #fff inset, 4px 4px 0 #7c5c2c";const s=M.getBoundingClientRect(),t=window.innerWidth,e=window.innerHeight,i=100,o=40,n=Math.max(s.left,0),d=Math.min(s.right-i,t-i),c=Math.max(s.top,0),f=Math.min(s.bottom-o,e-o),S=n+Math.random()*(d-n),H=c+Math.random()*(f-c);a.style.left=Math.round(S)+"px",a.style.top=Math.round(H)+"px"});a.addEventListener("mouseleave",()=>{a.style.background="#e0c080",a.style.boxShadow="0 0 0 2px #fff inset, 2px 2px 0 #7c5c2c"});document.body.appendChild(a);r.addEventListener("click",()=>{new Audio("win.mp3").play(),m&&(m.destroy(),m=null,P=!1),u&&(u.destroy(),u=null,v=!1),p.style.display="none",r.style.display="none",a.style.display="none",N=!0;const t=document.createElement("div");t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.width="100vw",t.style.height="100vh",t.style.pointerEvents="none",t.style.zIndex="9999",document.body.appendChild(t);const e=["#f9d423","#ff4e50","#a1ffce","#38b2ac","#ff6e7f","#bfe9ff","#fbc2eb","#fdc2a2"];for(let o=0;o<80;o++){const n=document.createElement("div");n.style.position="absolute",n.style.width="12px",n.style.height="12px",n.style.background=e[Math.floor(Math.random()*e.length)],n.style.borderRadius=Math.random()>.5?"50%":"0",n.style.left=Math.random()*window.innerWidth+"px",n.style.top="-20px",n.style.opacity="0.85",n.style.transform=`rotate(${Math.random()*360}deg)`,n.style.boxShadow="0 2px 6px rgba(0,0,0,0.1)",n.style.animation="confetti-fall 3s linear forwards",t.appendChild(n)}const i=document.createElement("style");i.innerHTML=`@keyframes confetti-fall {
    0% { opacity: 0.85; }
    80% { opacity: 0.85; }
    100% { top: 100vh; opacity: 0; }
  }`,document.head.appendChild(i),setTimeout(()=>{t.remove(),i.remove()},3e3)});a.addEventListener("mouseenter",()=>{const s=M.getBoundingClientRect(),t=window.innerWidth,e=window.innerHeight,i=100,o=40,n=Math.max(s.left,0),d=Math.min(s.right-i,t-i),c=Math.max(s.top,0),f=Math.min(s.bottom-o,e-o),S=n+Math.random()*(d-n),H=c+Math.random()*(f-c);a.style.left=Math.round(S)+"px",a.style.top=Math.round(H)+"px"});const M=document.querySelector("#game-canvas"),h=M.getContext("2d");h.imageSmoothingEnabled=!1;const y=new I({position:new l(0,0)}),lt=new w({resource:b.images.sky,frameSize:new l(1920,960),scale:.3}),dt=new w({resource:b.images.ground,frameSize:new l(320,180),position:new l(x(-3),x(0))});y.addChild(dt);const ct=new w({resource:b.images.house,frameSize:new l(80,112),position:new l(x(7),x(-2))});y.addChild(ct);let u=null,v=!1,m=null,P=!1;window.addEventListener("keydown",s=>{s.key.toLowerCase()==="e"&&v&&!P&&(m=new w({resource:b.images.letter,frameSize:new l(1e3,180),scale:.5,position:new l(x(5),x(.5))}),y.addChild(m),P=!0)});const O=new w({resource:b.images.mail,frameSize:new l(200,200),scale:.3,position:new l(x(9.8),x(.5))});y.addChild(O);let K=0;const ht=O.position.y,T=new ot(x(9),x(4));y.addChild(T);const k=new at;y.addChild(k);const pt=new rt;y.input=new q;const ft=s=>{if(!v&&P&&m&&(m.destroy(),m=null,P=!1,p.style.display="none",r.style.display="none",a.style.display="none"),P&&m){p.style.display="block",r.style.display="block",a.style.display="block";const c=M.getBoundingClientRect(),f=m.position.x+k.position.x+c.left+400,S=m.position.y+k.position.y+c.top+180;p.style.left=Math.round(f)+"px",p.style.top=Math.round(S)+"px",r.style.left=Math.round(f)+"px",r.style.top=Math.round(S+40)+"px",(a.style.left===""||a.style.display==="none")&&(a.style.left=Math.round(f+120)+"px",a.style.top=Math.round(S+40)+"px")}else p.style.display="none",r.style.display="none",a.style.display="none";y.stepEntry(s,y),K+=s;const t=1,e=.004;O.position.y=ht+Math.sin(K*e)*t;const i=T.position.x,o=T.position.y,n=[{x:160,y:64},{x:176,y:80},{x:192,y:64}];let d=!1;for(const c of n)if(Math.abs(i-c.x)<2&&Math.abs(o-c.y)<2){d=!0;break}d?v?(u.position.x=i,u.position.y=o-24):(u=new w({resource:b.images.icon,frameSize:new l(1e3,1e3),scale:.02,position:new l(i-20,o-300)}),y.addChild(u),v=!0):v&&u&&(u.destroy(),u=null,v=!1)},mt=()=>{if(h.clearRect(0,0,M.width,M.height),lt.drawImage(h,0,0),h.save(),h.translate(k.position.x,k.position.y),y.draw(h,0,0),v&&T&&!P&&!N){h.save(),h.font="bold 16px 'Press Start 2P', 'Courier New', monospace",h.fillStyle="#fff",h.strokeStyle="#000",h.lineWidth=2;const s="PRESS E",t=T.position.x+k.position.x-40,e=T.position.y+k.position.y+50;h.strokeText(s,t,e),h.fillText(s,t,e),h.restore()}h.restore(),pt.draw(h,0,0)},yt=new B(ft,mt);yt.start();
