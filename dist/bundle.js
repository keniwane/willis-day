(()=>{var Y=class{constructor(){this.toLoad={sky:"/sprites/sky.png",ground:"/sprites/ground.png",hero:"/sprites/hero-sheet.png",shadow:"/sprites/shadow.png",rod:"/sprites/rod.png",house:"/sprites/house.png",mail:"/sprites/mail.png",icon:"/sprites/icon.png",letter:"/sprites/letter.png"},this.images={},Object.keys(this.toLoad).forEach(t=>{let e=new Image;e.src=this.toLoad[t],this.images[t]={image:e,isLoaded:!1},e.onload=()=>{this.images[t].isLoaded=!0}})}},u=new Y;var a=class i{constructor(t=0,e=0){this.x=t,this.y=e}duplicate(){return new i(this.x,this.y)}};var X=class{callbacks=[];nextId=0;emit(t,e){this.callbacks.forEach(s=>{s.eventName===t&&s.callback(e)})}on(t,e,s){return this.nextId+=1,this.callbacks.push({id:this.nextId,eventName:t,caller:e,callback:s}),this.nextId}off(t){this.callbacks=this.callbacks.filter(e=>e.id!==t)}unsubscribe(t){this.callbacks=this.callbacks.filter(e=>e.caller!==t)}},v=new X;var f=class{constructor({position:t}){this.position=t??new a(0,0),this.children=[],this.parent=null,this.hasReadyBeenCalled=!1}stepEntry(t,e){this.children.forEach(s=>s.stepEntry(t,e)),this.hasReadyBeenCalled||(this.hasReadyBeenCalled=!0,this.ready()),this.step(t,e)}ready(){}step(t){}draw(t,e,s){let r=e+this.position.x,o=s+this.position.y;this.drawImage(t,r,o),this.children.forEach(c=>c.draw(t,r,o))}drawImage(t,e,s){}destroy(){this.children.forEach(t=>{t.destroy()}),this.parent.removeChild(this)}addChild(t){t.parent=this,this.children.push(t)}removeChild(t){v.unsubscribe(t),this.children=this.children.filter(e=>t!==e)}};var p=class extends f{constructor({resource:t,frameSize:e,hFrames:s,vFrames:r,frame:o,scale:c,position:l,animations:y}){super({name}),this.resource=t,this.frameSize=e??new a(16,16),this.hFrames=s??1,this.vFrames=r??1,this.frame=o??0,this.frameMap=new Map,this.scale=c??1,this.position=l??new a(0,0),this.animations=y??null,this.buildFrameMap()}buildFrameMap(){let t=0;for(let e=0;e<this.vFrames;e++)for(let s=0;s<this.hFrames;s++)this.frameMap.set(t,new a(this.frameSize.x*s,this.frameSize.y*e)),t++}step(t){this.animations&&(this.animations.step(t),this.frame=this.animations.frame)}drawImage(t,e,s){if(!this.resource.isLoaded)return;let r=0,o=0,c=this.frameMap.get(this.frame);c&&(r=c.x,o=c.y);let l=this.frameSize.x,y=this.frameSize.y;t.drawImage(this.resource.image,r,o,l,y,e,s,l*this.scale,y*this.scale)}};var W=class{constructor(t,e){this.lastFrameTime=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=e,this.rafId=null,this.isRunning=!1}mainLoop=t=>{if(!this.isRunning)return;let e=t-this.lastFrameTime;for(this.lastFrameTime=t,this.accumulatedTime+=e;this.accumulatedTime>=this.timeStep;)this.update(this.timeStep),this.accumulatedTime-=this.timeStep;this.render(),this.rafId=requestAnimationFrame(this.mainLoop)};start(){this.isRunning||(this.isRunning=!0,this.rafId=requestAnimationFrame(this.mainLoop))}stop(){this.rafId&&cancelAnimationFrame(this.rafId),this.isRunning=!1}};var L="LEFT",D="RIGHT",R="UP",E="DOWN",_=class{constructor(){this.heldDirections=[],document.addEventListener("keydown",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowPressed(R),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowPressed(E),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowPressed(L),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowPressed(D)}),document.addEventListener("keyup",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowReleased(R),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowReleased(E),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowReleased(L),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowReleased(D)})}get direction(){return this.heldDirections[0]}onArrowPressed(t){this.heldDirections.indexOf(t)===-1&&this.heldDirections.unshift(t)}onArrowReleased(t){let e=this.heldDirections.indexOf(t);e!==-1&&this.heldDirections.splice(e,1)}};var x=i=>i*16,B=(i,t,e)=>{let s=`${t},${e}`;return!i.has(s)};var P=new Set;P.add("144,48");P.add("160,48");P.add("176,64");P.add("128,48");P.add("112,48");var K=class{constructor(t){this.patterns=t,this.activeKey=Object.keys(this.patterns)[0]}get frame(){return this.patterns[this.activeKey].frame}play(t,e=0){this.activeKey!==t&&(this.activeKey=t,this.patterns[this.activeKey].currentTime=e)}step(t){this.patterns[this.activeKey].step(t)}};var w=class{constructor(t){this.currentTime=0,this.animationConfig=t,this.duration=t.duration??500}get frame(){let{frames:t}=this.animationConfig;for(let e=t.length-1;e>=0;e--)if(this.currentTime>=t[e].time)return t[e].frame;throw"Time is before the first keyframe"}step(t){this.currentTime+=t,this.currentTime>=this.duration&&(this.currentTime=0)}};var F=(i=0)=>({duration:400,frames:[{time:0,frame:i}]}),H=(i=0)=>({duration:400,frames:[{time:0,frame:i+1},{time:100,frame:i},{time:200,frame:i+1},{time:300,frame:i+2}]}),$=F(1),q=F(4),V=F(7),j=F(10),Z=H(0),J=H(3),Q=H(6),tt=H(9),et={duration:400,frames:[{time:0,frame:12}]};function it(i,t,e){let s=t.x-i.position.x,r=t.y-i.position.y,o=Math.sqrt(s**2+r**2);if(o<=e)i.position.x=t.x,i.position.y=t.y;else{let c=s/o,l=r/o;i.position.x+=c*e,i.position.y+=l*e,s=t.x-i.position.x,r=t.y-i.position.y,o=Math.sqrt(s**2+r**2)}return o}var N=class extends f{constructor(t,e){super({position:new a(t,e)});let s=new p({resource:u.images.shadow,frameSize:new a(32,32),position:new a(-8,-19)});this.addChild(s),this.body=new p({resource:u.images.hero,frameSize:new a(32,32),hFrames:3,vFrames:8,frame:1,position:new a(-8,-20),animations:new K({walkDown:new w(Z),walkUp:new w(Q),walkLeft:new w(tt),walkRight:new w(J),standDown:new w($),standUp:new w(V),standLeft:new w(j),standRight:new w(q),pickUpDown:new w(et)})}),this.addChild(this.body),this.facingDirection=E,this.destinationPosition=this.position.duplicate(),this.itemPickupTime=0,this.itemPickupShell=null,v.on("HERO_PICKS_UP_ITEM",this,r=>{this.onPickUpItem(r)})}step(t,e){if(this.itemPickupTime>0){this.workOnItemPickup(t);return}it(this,this.destinationPosition,1)<=1&&this.tryMove(e),this.tryEmitPosition()}tryEmitPosition(){if(this.lastX===this.position.x&&this.lastY===this.position.y)return;this.lastX=this.position.x,this.lastY=this.position.y;let t=Math.floor(this.position.x/16),e=Math.floor(this.position.y/16);console.log(`Player grid position: (${this.lastX}, ${this.lastY})`),v.emit("HERO_POSITION",this.position)}w;tryMove(t){let{input:e}=t;if(!e.direction){this.facingDirection===L&&this.body.animations.play("standLeft"),this.facingDirection===D&&this.body.animations.play("standRight"),this.facingDirection===R&&this.body.animations.play("standUp"),this.facingDirection===E&&this.body.animations.play("standDown");return}let s=this.destinationPosition.x,r=this.destinationPosition.y,o=16;e.direction===E&&(r+=o,this.body.animations.play("walkDown")),e.direction===R&&(r-=o,this.body.animations.play("walkUp")),e.direction===L&&(s-=o,this.body.animations.play("walkLeft")),e.direction===D&&(s+=o,this.body.animations.play("walkRight")),this.facingDirection=e.direction??this.facingDirection,B(P,s,r)&&(this.destinationPosition.x=s,this.destinationPosition.y=r)}onPickUpItem({image:t,position:e}){this.destinationPosition=e.duplicate(),this.itemPickupTime=500,this.itemPickupShell=new f({}),this.itemPickupShell.addChild(new p({resource:t,position:new a(0,-18)})),this.addChild(this.itemPickupShell)}workOnItemPickup(t){this.itemPickupTime-=t,this.body.animations.play("pickUpDown"),this.itemPickupTime<=0&&this.itemPickupShell.destroy()}};var O=class extends f{constructor(){super({}),v.on("HERO_POSITION",this,t=>{this.position=new a(-t.x+152,-t.y+82)})}};var z=class extends f{constructor(){super({position:new a(0,1)}),this.nextId=0,this.items=[],v.on("HERO_PICKS_UP_ITEM",this,t=>{this.nextId+=1,this.items.push({id:this.nextId,image:u.images.rod}),this.renderInventory()}),this.renderInventory()}renderInventory(){this.children.forEach(t=>t.destroy()),this.items.forEach((t,e)=>{let s=new p({resource:t.image,position:new a(e*12,0)});this.addChild(s)})}removeFromInventory(t){this.items=this.items.filter(e=>e.id!==t),this.renderInventory()}};var m=document.createElement("div");m.innerText="Will you be my valentine? \u2764\uFE0F - Ken";m.style.position="absolute";m.style.fontFamily="'Press Start 2P', 'Courier New', monospace";m.style.fontSize="24px";m.style.color="#222";m.style.pointerEvents="none";m.style.display="none";document.body.appendChild(m);var ot=!1,d=document.createElement("button");d.innerText="Yes";d.style.position="absolute";d.style.fontFamily="'Press Start 2P', 'Courier New', monospace";d.style.fontSize="18px";d.style.padding="8px 24px";d.style.display="none";d.style.zIndex=10;d.style.background="#e0c080";d.style.border="4px solid #7c5c2c";d.style.borderRadius="0";d.style.boxShadow="0 0 0 2px #fff inset, 2px 2px 0 #7c5c2c";d.style.color="#3a2a0a";d.style.textShadow="1px 1px 0 #fff, -1px -1px 0 #fff";d.style.cursor="pointer";d.style.outline="none";d.style.transition="background 0.2s, box-shadow 0.2s";d.addEventListener("mouseenter",()=>{d.style.background="#fff6d6",d.style.boxShadow="0 0 0 2px #fff inset, 4px 4px 0 #7c5c2c"});d.addEventListener("mouseleave",()=>{d.style.background="#e0c080",d.style.boxShadow="0 0 0 2px #fff inset, 2px 2px 0 #7c5c2c"});document.body.appendChild(d);var n=document.createElement("button");n.innerText="No";n.style.position="absolute";n.style.fontFamily="'Press Start 2P', 'Courier New', monospace";n.style.fontSize="18px";n.style.padding="8px 24px";n.style.display="none";n.style.zIndex=10;n.style.background="#e0c080";n.style.border="4px solid #7c5c2c";n.style.borderRadius="0";n.style.boxShadow="0 0 0 2px #fff inset, 2px 2px 0 #7c5c2c";n.style.color="#3a2a0a";n.style.textShadow="1px 1px 0 #fff, -1px -1px 0 #fff";n.style.cursor="pointer";n.style.outline="none";n.style.transition="background 0.2s, box-shadow 0.2s";n.addEventListener("mouseenter",()=>{n.style.background="#fff6d6",n.style.boxShadow="0 0 0 2px #fff inset, 4px 4px 0 #7c5c2c";let i=C.getBoundingClientRect(),t=window.innerWidth,e=window.innerHeight,s=100,r=40,o=Math.max(i.left,0),c=Math.min(i.right-s,t-s),l=Math.max(i.top,0),y=Math.min(i.bottom-r,e-r),T=o+Math.random()*(c-o),U=l+Math.random()*(y-l);n.style.left=Math.round(T)+"px",n.style.top=Math.round(U)+"px"});n.addEventListener("mouseleave",()=>{n.style.background="#e0c080",n.style.boxShadow="0 0 0 2px #fff inset, 2px 2px 0 #7c5c2c"});document.body.appendChild(n);d.addEventListener("click",()=>{new Audio("/win.mp3").play(),g&&(g.destroy(),g=null,M=!1),S&&(S.destroy(),S=null,k=!1),m.style.display="none",d.style.display="none",n.style.display="none",ot=!0;let t=document.createElement("div");t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.width="100vw",t.style.height="100vh",t.style.pointerEvents="none",t.style.zIndex="9999",document.body.appendChild(t);let e=["#f9d423","#ff4e50","#a1ffce","#38b2ac","#ff6e7f","#bfe9ff","#fbc2eb","#fdc2a2"];for(let r=0;r<80;r++){let o=document.createElement("div");o.style.position="absolute",o.style.width="12px",o.style.height="12px",o.style.background=e[Math.floor(Math.random()*e.length)],o.style.borderRadius=Math.random()>.5?"50%":"0",o.style.left=Math.random()*window.innerWidth+"px",o.style.top="-20px",o.style.opacity="0.85",o.style.transform=`rotate(${Math.random()*360}deg)`,o.style.boxShadow="0 2px 6px rgba(0,0,0,0.1)",o.style.animation=`confetti-fall ${2+Math.random()*2}s linear forwards`,t.appendChild(o)}let s=document.createElement("style");s.innerHTML=`@keyframes confetti-fall {
    0% { opacity: 0.85; }
    80% { opacity: 0.85; }
    100% { top: 100vh; opacity: 0; }
  }`,document.head.appendChild(s),setTimeout(()=>{t.remove(),s.remove()},4e3)});n.addEventListener("mouseenter",()=>{let i=C.getBoundingClientRect(),t=window.innerWidth,e=window.innerHeight,s=100,r=40,o=Math.max(i.left,0),c=Math.min(i.right-s,t-s),l=Math.max(i.top,0),y=Math.min(i.bottom-r,e-r),T=o+Math.random()*(c-o),U=l+Math.random()*(y-l);n.style.left=Math.round(T)+"px",n.style.top=Math.round(U)+"px"});var C=document.querySelector("#game-canvas"),h=C.getContext("2d");h.imageSmoothingEnabled=!1;var b=new f({position:new a(0,0)}),nt=new p({resource:u.images.sky,frameSize:new a(1920,960),scale:.3}),rt=new p({resource:u.images.ground,frameSize:new a(320,180),position:new a(x(-3),x(0))});b.addChild(rt);var at=new p({resource:u.images.house,frameSize:new a(80,112),position:new a(x(7),x(-2))});b.addChild(at);var S=null,k=!1,g=null,M=!1;window.addEventListener("keydown",i=>{i.key.toLowerCase()==="e"&&k&&!M&&(g=new p({resource:u.images.letter,frameSize:new a(1e3,180),scale:.5,position:new a(x(5),x(.5))}),b.addChild(g),M=!0)});var G=new p({resource:u.images.mail,frameSize:new a(200,200),scale:.3,position:new a(x(9.8),x(.5))});b.addChild(G);var st=0,dt=G.position.y,A=new N(x(9),x(4));b.addChild(A);var I=new O;b.addChild(I);var lt=new z;b.input=new _;var ct=i=>{if(!k&&M&&g&&(g.destroy(),g=null,M=!1,m.style.display="none",d.style.display="none",n.style.display="none"),M&&g){m.style.display="block",d.style.display="block",n.style.display="block";let l=C.getBoundingClientRect(),y=g.position.x+I.position.x+l.left+400,T=g.position.y+I.position.y+l.top+180;m.style.left=Math.round(y)+"px",m.style.top=Math.round(T)+"px",d.style.left=Math.round(y)+"px",d.style.top=Math.round(T+40)+"px",(n.style.left===""||n.style.display==="none")&&(n.style.left=Math.round(y+120)+"px",n.style.top=Math.round(T+40)+"px")}else m.style.display="none",d.style.display="none",n.style.display="none";b.stepEntry(i,b),st+=i;let t=1,e=.004;G.position.y=dt+Math.sin(st*e)*t;let s=A.position.x,r=A.position.y,o=[{x:160,y:64},{x:176,y:80},{x:192,y:64}],c=!1;for(let l of o)if(Math.abs(s-l.x)<2&&Math.abs(r-l.y)<2){c=!0;break}c?k?(S.position.x=s,S.position.y=r-24):(S=new p({resource:u.images.icon,frameSize:new a(1e3,1e3),scale:.02,position:new a(s-20,r-300)}),b.addChild(S),k=!0):k&&S&&(S.destroy(),S=null,k=!1)},ht=()=>{if(h.clearRect(0,0,C.width,C.height),nt.drawImage(h,0,0),h.save(),h.translate(I.position.x,I.position.y),b.draw(h,0,0),k&&A&&!M&&!ot){h.save(),h.font="bold 16px 'Press Start 2P', 'Courier New', monospace",h.fillStyle="#fff",h.strokeStyle="#000",h.lineWidth=2;let i="PRESS E",t=A.position.x+I.position.x-40,e=A.position.y+I.position.y+50;h.strokeText(i,t,e),h.fillText(i,t,e),h.restore()}h.restore(),lt.draw(h,0,0)},pt=new W(ct,ht);pt.start();})();
